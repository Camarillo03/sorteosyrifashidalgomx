<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sorteos Y Rifas Hidalgo, MX</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Open+Sans:wght@300;400&display=swap" rel="stylesheet">
  <style>
    :root {
      --verde-hidalgo: #009c4d;
      --blanco-hidalgo: #ffffff;
      --rojo-hidalgo: #e60012;
    }

    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #f4f7fc;
      margin: 0;
      padding: 0;
      color: #333;
    }

    .banner-presentacion {
      background: linear-gradient(90deg, #f44336, #ff9800, #ffeb3b);
      color: #000;
      padding: 15px 10px;
      text-align: center;
      font-size: 18px;
      font-weight: 500;
      border-bottom: 2px solid #e65100;
    }

    header {
      background-color: var(--verde-hidalgo);
      color: var(--blanco-hidalgo);
      padding: 40px 0;
      text-align: center;
    }

    header h1 {
      font-size: 48px;
      font-family: 'Roboto', sans-serif;
      margin: 0;
    }

    header p {
      font-size: 18px;
      margin-top: 10px;
    }

    nav {
      background-color: var(--rojo-hidalgo);
      padding: 15px 0;
      text-align: center;
    }

    nav a {
      color: var(--blanco-hidalgo);
      text-decoration: none;
      margin: 0 20px;
      font-size: 18px;
      font-weight: 500;
    }

    nav a:hover {
      text-decoration: underline;
      color: #e5e5e5;
    }

    .seleccionados-bar {
      background-color: #fff9c4;
      border-bottom: 2px solid #fbc02d;
      padding: 15px;
      font-weight: bold;
      text-align: center;
    }

    .seleccionados-bar span {
      margin: 0 5px;
      background: #ffe082;
      padding: 5px 10px;
      border-radius: 5px;
    }

    .seleccionados-bar button {
      background-color: #e60012;
      color: white;
      border: none;
      padding: 5px 10px;
      margin-left: 5px;
      cursor: pointer;
      border-radius: 5px;
    }

    .pagination {
      text-align: center;
      margin: 20px auto 10px;
    }

    .pagination button {
      padding: 10px 20px;
      margin: 0 5px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: var(--verde-hidalgo);
      color: var(--blanco-hidalgo);
    }

    .pagination button.active {
      background-color: var(--rojo-hidalgo);
    }

    .boletos-section {
      margin: 20px auto;
      padding: 30px;
      background: var(--blanco-hidalgo);
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 1200px;
    }

    .boletos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
    }

    .boleto {
      padding: 15px;
      text-align: center;
      background: #f1f1f1;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .boleto:hover {
      background-color: var(--verde-hidalgo);
      color: var(--blanco-hidalgo);
    }

    .boleto.seleccionado {
      background-color: var(--rojo-hidalgo);
      color: var(--blanco-hidalgo);
    }

    .boleto.vendido {
      background-color: #cccccc;
      color: #666;
      text-decoration: line-through;
      cursor: not-allowed;
    }

    .btn-apartar {
      display: block;
      margin: 20px auto 0;
      padding: 15px 25px;
      font-size: 18px;
      background-color: var(--verde-hidalgo);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    .btn-apartar:hover {
      background-color: #006837;
    }

    .maquina-suerte {
      margin: 30px auto;
      padding: 30px;
      background-color: var(--blanco-hidalgo);
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 600px;
      text-align: center;
    }

    .maquina-suerte input {
      width: 100%;
      padding: 12px;
      margin: 12px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    .maquina-suerte button {
      padding: 12px 20px;
      background-color: var(--verde-hidalgo);
      color: var(--blanco-hidalgo);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
    }

    .maquina-suerte button:hover {
      background-color: #006837;
    }

    #popup {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 30px;
      border: 2px solid var(--verde-hidalgo);
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      display: none;
      z-index: 1000;
      text-align: center;
    }

    #popup a {
      display: inline-block;
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #25d366;
      color: white;
      border-radius: 5px;
      text-decoration: none;
    }

    footer {
      background-color: var(--verde-hidalgo);
      color: var(--blanco-hidalgo);
      padding: 20px 0;
      text-align: center;
      margin-top: 40px;
    }
    
    .btn-recargar {
      display: block;
      margin: 10px auto;
      padding: 10px 15px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
<style>
  .boleto.vendido {
    text-decoration: line-through;
    background-color: #ccc;
    color: #666;
    pointer-events: none;
    cursor: not-allowed;
  }
</style>
</head>
<body>

<div class="banner-presentacion">
  <strong>🎉 ¡Rifa de $2000 MXN 🎉</strong>
  <p>Cada Boleto X Solo <strong>$1 MXN</strong> C/U Con <strong>5 Oportunidades</strong> De ganar. ¡Aparta Los Tuyos Ya!</p>
</div>

<header>
  <h1>Sorteos Y Rifas Hidalgo, MX</h1>
  <p>Participa en sorteos y rifas para ganar premios increíbles. ¡Compra tus boletos ahora!</p>
  <p>En La Compra De 100 Boletos Te Regalamos 10 Numeros Para La Rifa #2</p>
  <p>Rifa En Base A La Loteria Nacional Mexicana</p>
</header>

<nav>
  <a href="#">Inicio</a>
  <a href="#">Sorteos</a>
  <a href="#">Cómo Funciona</a>
  <a href="#">Contacto</a>
</nav>

<button class="btn-recargar" onclick="recargarBoletos()">Actualizar Estado de Boletos</button>

<div class="seleccionados-bar" id="barra-seleccion">
  No has seleccionado ningún boleto.
</div>

<div class="boletos-section">
  <div class="pagination" id="pagination"></div>
  <div class="boletos-grid" id="boletos-grid"></div>
</div>

<button class="btn-apartar" onclick="mostrarPopup()">Apartar Boletos Seleccionados</button>

<div class="maquina-suerte">
  <h3>Máquina de la Suerte</h3>
  <p>Ingresa la cantidad de números que deseas generar (hasta 1000):</p>
  <input type="number" id="cantidad-numeros" placeholder="Cantidad de números" min="1" max="1000" />
  <button onclick="generarNumerosAleatorios()">Generar Números</button>
  <div id="numeros-generados" style="margin-top: 20px; font-size: 18px;"></div>
</div>

<div id="popup">
  <h3>¡Gracias por apartar tus boletos!</h3>
  <p>Verifica tu compra a través de WhatsApp:</p>
  <a id="whatsapp-link" href="#" target="_blank">Confirmar por WhatsApp</a>
</div>

<footer>
  <p>Rifa condicionada a la venta mínima del 75% de los boletos</p>
  <p>En caso de no venderse la cantidad mínima, la fecha se pospondrá una semana hasta llegar al mínimo. Sin límite de tiempo.</p>
  <p>&copy; 2025 Sorteos Y Rifas Hidalgo, MX | Todos los derechos reservados</p>
</footer>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  // Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAEAcEviWNEvJ-6o8xBs7ZeKX5nkNt-XCg",
    authDomain: "rifas-y-sorteos-hidalgo-mx.firebaseapp.com",
    databaseURL: "https://rifas-y-sorteos-hidalgo-mx-default-rtdb.firebaseio.com",
    projectId: "rifas-y-sorteos-hidalgo-mx",
    storageBucket: "rifas-y-sorteos-hidalgo-mx.firebasestorage.app",
    messagingSenderId: "498421618503",
    appId: "1:498421618503:web:0ca7cedde3a4cb91a9de62",
    measurementId: "G-P07FSW28S8"
  };

  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Variables globales
  const totalBoletos = 10000;
  const boletosPorPagina = 1500;
  let paginaActual = 1;
  let boletosSeleccionados = [];
  let boletosVendidos = [];

  // Función para formatear números con ceros a la izquierda
  function formatearNumero(num) {
    return String(num).padStart(5, '0');
  }

  // Función principal para generar los boletos en la página
  function generarBoletos() {
    const boletosGrid = document.getElementById("boletos-grid");
    boletosGrid.innerHTML = "";
    const inicio = (paginaActual - 1) * boletosPorPagina + 1;
    const fin = Math.min(paginaActual * boletosPorPagina, totalBoletos);

    console.log(`Generando boletos ${inicio} a ${fin}`);
    console.log("Boletos vendidos actuales:", boletosVendidos);

    for (let i = inicio; i <= fin; i++) {
      const div = document.createElement("div");
      div.classList.add("boleto");
      div.innerText = formatearNumero(i);
      div.setAttribute("data-numero", formatearNumero(i));
      div.setAttribute("data-id", i);

      // Verificación más detallada
      const esVendido = boletosVendidos.includes(i);
      const esSeleccionado = boletosSeleccionados.includes(i);
      
      console.log(`Boleto ${i}: vendido=${esVendido}, seleccionado=${esSeleccionado}`);

      if (esVendido) {
        div.classList.add("vendido");
      } else if (esSeleccionado) {
        div.classList.add("seleccionado");
      }

      div.onclick = () => {
        if (!esVendido) toggleSeleccion(i);
      };

      boletosGrid.appendChild(div);
    }
  }

  // Función para alternar la selección de boletos
  function toggleSeleccion(num) {
    const index = boletosSeleccionados.indexOf(num);
    if (index > -1) {
      boletosSeleccionados.splice(index, 1);
    } else {
      boletosSeleccionados.push(num);
    }
    actualizarBarra();
    generarBoletos();
  }

  // Función para actualizar la barra de selección
  function actualizarBarra() {
    const barra = document.getElementById("barra-seleccion");
    if (boletosSeleccionados.length === 0) {
      barra.innerHTML = "No has seleccionado ningún boleto.";
    } else {
      barra.innerHTML = "Boletos seleccionados: ";
      boletosSeleccionados.forEach(num => {
        const span = document.createElement("span");
        span.innerText = formatearNumero(num);
        const btn = document.createElement("button");
        btn.innerText = "x";
        btn.onclick = () => toggleSeleccion(num);
        span.appendChild(btn);
        barra.appendChild(span);
      });

      const limpiarBtn = document.createElement("button");
      limpiarBtn.innerText = "Borrar todos";
      limpiarBtn.onclick = () => {
        boletosSeleccionados = [];
        actualizarBarra();
        generarBoletos();
      };
      barra.appendChild(limpiarBtn);
    }
  }

  // Función para generar números aleatorios
  function generarNumerosAleatorios() {
    const cantidad = parseInt(document.getElementById("cantidad-numeros").value);
    const numeros = [];
    if (cantidad > 0 && cantidad <= 1000) {
      while (numeros.length < cantidad) {
        let numero = Math.floor(Math.random() * totalBoletos) + 1;
        if (!boletosSeleccionados.includes(numero) && !numeros.includes(numero) && !boletosVendidos.includes(numero)) {
          numeros.push(numero);
          boletosSeleccionados.push(numero);
        }
      }
      actualizarBarra();
      generarBoletos();
      document.getElementById("numeros-generados").innerText = "Números generados: " + numeros.map(formatearNumero).join(", ");
    } else {
      alert("Cantidad inválida. Ingresa un número entre 1 y 1000.");
    }
  }

  // Función para mostrar el popup de confirmación
  function mostrarPopup() {
    if (boletosSeleccionados.length === 0) {
      alert("Selecciona al menos un boleto antes de apartar.");
      return;
    }

    const popup = document.getElementById("popup");
    const link = document.getElementById("whatsapp-link");
    const numeros = boletosSeleccionados.map(formatearNumero);
    const cantidad = boletosSeleccionados.length;
    const mensaje = `Hola, quiero confirmar la compra para la gran rifa de $2000 MXN de ${cantidad} boletos: ${numeros.join(", ")}`;
    const url = `https://wa.me/527737345346?text=${encodeURIComponent(mensaje)}`;
    link.href = url;
    popup.style.display = "block";
  }

  // Función para cambiar de página
  function cambiarPagina(pagina) {
    paginaActual = pagina;
    generarBoletos();
    mostrarPaginacion();
  }

  // Función para mostrar la paginación
  function mostrarPaginacion() {
    const pagination = document.getElementById("pagination");
    const totalPaginas = Math.ceil(totalBoletos / boletosPorPagina);
    pagination.innerHTML = "";

    for (let i = 1; i <= totalPaginas; i++) {
      const button = document.createElement("button");
      button.innerText = i;
      button.onclick = () => cambiarPagina(i);
      if (i === paginaActual) {
        button.classList.add("active");
      }
      pagination.appendChild(button);
    }
  }

  // Función para cargar los boletos vendidos desde Firestore
  async function cargarBoletosVendidos() {
    try {
      console.log("Cargando boletos vendidos desde Firestore...");
      const querySnapshot = await db.collection("boletos").get();
      const nuevosVendidos = [];
      
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        // Manejo más robusto del número del boleto
        const numero = parseInt(data.numero || data.numeroBoleto || doc.id);
        
        // Verificación más robusta del estado
        const estado = (data.estado || data.estatus || "").toLowerCase();
        if ((estado === "vendido") && !isNaN(numero)) {
          nuevosVendidos.push(numero);
        } else {
          console.log(`Boleto ${numero} no está vendido (estado: ${estado})`);
        }
      });
      
      // Actualizamos solo si hay cambios
      if (JSON.stringify(nuevosVendidos) !== JSON.stringify(boletosVendidos)) {
        boletosVendidos = nuevosVendidos;
        console.log(`Boletos vendidos actualizados: ${boletosVendidos.length}`);
        console.log("Ejemplo de boletos vendidos:", boletosVendidos.slice(0, 10));
        generarBoletos();
      } else {
        console.log("No hay cambios en los boletos vendidos");
      }
    } catch (error) {
      console.error("Error al cargar boletos vendidos:", error);
    }
  }

  // Función para recargar los boletos
  function recargarBoletos() {
    console.log("Recargando boletos...");
    cargarBoletosVendidos().then(() => {
      alert("Estado de los boletos actualizado");
    });
  }

  // Escuchador de cambios en tiempo real
  function configurarListenerEnTiempoReal() {
    db.collection("boletos").onSnapshot((querySnapshot) => {
      console.log("Cambio detectado en Firestore. Documentos afectados:", querySnapshot.docChanges().length);
      querySnapshot.docChanges().forEach(change => {
        console.log(`Cambio en boleto ${change.doc.id}:`, 
          change.type, change.doc.data());
      });
      cargarBoletosVendidos();
    }, (error) => {
      console.error("Error en listener en tiempo real:", error);
    });
  }

  // Inicialización cuando la página carga
  window.addEventListener('DOMContentLoaded', () => {
    cargarBoletosVendidos();
    mostrarPaginacion();
    actualizarBarra();
    configurarListenerEnTiempoReal();
    
    // Verificar si hay parámetros de depuración en la URL
    if (window.location.search.includes('debug=1')) {
      console.log("Modo depuración activado");
      setInterval(cargarBoletosVendidos, 30000); // Recargar cada 30 segundos
    }
  });

  // Función para limpiar boletos vendidos (solo para administradores)
  async function limpiarBoletosVendidos() {
    if (!confirm("¿Estás seguro de querer marcar TODOS los boletos como disponibles?")) return;
    
    try {
      const querySnapshot = await db.collection("boletos").get();
      const batch = db.batch();
      let contador = 0;

      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const estado = (data.estado || data.estatus || "").toLowerCase();
        if (estado === "vendido") {
          batch.update(doc.ref, { 
            estado: "disponible",
            estatus: "disponible"
          });
          contador++;
        }
      });

      if (contador > 0) {
        await batch.commit();
        alert(`✅ ${contador} boletos actualizados a "disponible"`);
        cargarBoletosVendidos();
      } else {
        alert("🚫 No se encontraron boletos que necesitaran ser corregidos.");
      }
    } catch (error) {
      console.error("Error al limpiar boletos:", error);
      alert("❌ Error al limpiar boletos: " + error.message);
    }
  }
</script>

</body>
</html>
